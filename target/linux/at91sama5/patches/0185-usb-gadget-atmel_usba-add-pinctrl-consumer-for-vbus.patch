From c37d08f23a39cf08cec75c30e9839a64330be0a9 Mon Sep 17 00:00:00 2001
From: Bo Shen <voice.shen@atmel.com>
Date: Tue, 11 Dec 2012 15:31:52 +0800
Subject: [PATCH 185/319] usb: gadget: atmel_usba: add pinctrl consumer for
 vbus

Signed-off-by: Bo Shen <voice.shen@atmel.com>
---
 drivers/usb/gadget/atmel_usba_udc.c |    9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/usb/gadget/atmel_usba_udc.c b/drivers/usb/gadget/atmel_usba_udc.c
index 75704da..22eaba6 100644
--- a/drivers/usb/gadget/atmel_usba_udc.c
+++ b/drivers/usb/gadget/atmel_usba_udc.c
@@ -23,6 +23,7 @@
 #include <linux/delay.h>
 #include <linux/of.h>
 #include <linux/of_gpio.h>
+#include <linux/pinctrl/consumer.h>
 
 #include <asm/gpio.h>
 #include <mach/board.h>
@@ -1865,12 +1866,20 @@ static struct usba_ep *atmel_udc_of_init(struct platform_device *pdev,
 	struct device_node *pp;
 	int i, ret;
 	struct usba_ep *eps, *ep;
+	struct pinctrl *pinctrl;
 
 	udc->num_ep = 0;
 
 	udc->vbus_pin = of_get_named_gpio_flags(np, "atmel,vbus-gpio", 0,
 						&flags);
 	udc->vbus_pin_inverted = (flags & OF_GPIO_ACTIVE_LOW) ? 1 : 0;
+	if (udc->vbus_pin) {
+		pinctrl = devm_pinctrl_get_select_default(&pdev->dev);
+		if (IS_ERR(pinctrl)) {
+			dev_warn(&pdev->dev, "no pinctrl for vbus pin\n");
+			udc->vbus_pin = EINVAL;
+		}
+	}
 
 	pp = NULL;
 	while ((pp = of_get_next_child(np, pp)))
-- 
1.7.10.4

