From e64646348f0db31f53f09fcdd9711cb59737b2d1 Mon Sep 17 00:00:00 2001
From: Jean-Christophe PLAGNIOL-VILLARD <plagnioj@jcrosoft.com>
Date: Mon, 26 Nov 2012 15:07:27 +0100
Subject: [PATCH 117/319] video: atmel lcd only request the pinctrl once

Introduce simple bus to represent the LCDC itself so we can attached the
pinctrl to it
---
 drivers/video/atmel_lcdfb_core.c |   51 ++++++++++++++++++++++++++++++++------
 1 file changed, 43 insertions(+), 8 deletions(-)

diff --git a/drivers/video/atmel_lcdfb_core.c b/drivers/video/atmel_lcdfb_core.c
index b71a80c..4d272ee 100644
--- a/drivers/video/atmel_lcdfb_core.c
+++ b/drivers/video/atmel_lcdfb_core.c
@@ -19,6 +19,8 @@
 #include <linux/init.h>
 #include <linux/delay.h>
 #include <linux/gfp.h>
+#include <linux/of.h>
+#include <linux/of_device.h>
 
 #include <mach/board.h>
 #include <mach/cpu.h>
@@ -557,7 +559,6 @@ int __atmel_lcdfb_probe(struct platform_device *pdev,
 	struct resource *regs = NULL, *clut = NULL;
 	struct resource *map = NULL;
 	int ret;
-	struct pinctrl *pinctrl;
 
 	dev_dbg(dev, "%s BEGIN\n", __func__);
 
@@ -637,13 +638,6 @@ int __atmel_lcdfb_probe(struct platform_device *pdev,
 		goto stop_clk;
 	}
 
-	pinctrl = devm_pinctrl_get_select_default(dev);
-	if (IS_ERR(pinctrl)) {
-		dev_err(dev, "Failed to request pinctrl\n");
-		ret = PTR_ERR(pinctrl);
-		goto stop_clk;
-	}
-
 	/* No error checking, some devices can do without IRQ */
 	sinfo->irq_base = platform_get_irq(pdev, 0);
 
@@ -840,3 +834,44 @@ int __atmel_lcdfb_remove(struct platform_device *pdev)
 	return 0;
 }
 EXPORT_SYMBOL_GPL(__atmel_lcdfb_remove);
+
+static const struct of_device_id atmel_lcdfb_bus_dt_ids[] = {
+	{ .compatible = "atmel,at91sam9x5-lcd-bus" },
+	{ /* sentinel */ }
+};
+
+static int atmel_lcdfb_bus_probe(struct platform_device *pdev)
+{
+	struct pinctrl *pinctrl;
+	struct device *dev = &pdev->dev;
+
+	pinctrl = devm_pinctrl_get_select_default(dev);
+	if (IS_ERR(pinctrl)) {
+		dev_err(dev, "Failed to request pinctrl\n");
+		return PTR_ERR(pinctrl);
+	}
+
+	return 0;
+}
+
+static struct platform_driver atmel_lcdfb_bus = {
+	.probe		= atmel_lcdfb_bus_probe,
+	.driver		= {
+		.name	= "atmel_lcdfb_bus",
+		.owner	= THIS_MODULE,
+		.of_match_table	= of_match_ptr(atmel_lcdfb_bus_dt_ids),
+	},
+};
+
+static int __init atmel_lcdfb_bus_init(void)
+{
+	return platform_driver_register(&atmel_lcdfb_bus);
+}
+
+static void __exit atmel_lcdfb_bus_exit(void)
+{
+	platform_driver_unregister(&atmel_lcdfb_bus);
+}
+
+module_init(atmel_lcdfb_bus_init);
+module_exit(atmel_lcdfb_bus_exit);
-- 
1.7.10.4

